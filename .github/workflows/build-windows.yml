name: Build Windows

on:
  workflow_dispatch:
    inputs:
      edition:
        description: 'æ„å»ºç‰ˆæœ¬ç±»å‹ï¼ˆtrial è¯•ç”¨ç‰ˆ æˆ– release æ­£å¼ç‰ˆï¼‰'
        required: true
        default: 'release'
        type: choice
        options:
          - trial
          - release
      trial_duration:
        description: 'è¯•ç”¨æœŸæ—¶é•¿ï¼ˆä»…è¯•ç”¨ç‰ˆéœ€è¦ï¼Œä¾‹å¦‚ï¼š5ï¼‰'
        required: false
        default: '5'
        type: string
      trial_unit:
        description: 'è¯•ç”¨æœŸæ—¶é—´å•ä½ï¼ˆä»…è¯•ç”¨ç‰ˆéœ€è¦ï¼‰'
        required: false
        default: 'minutes'
        type: choice
        options:
          - seconds
          - minutes
          - hours
          - days
      device_fingerprint:
        description: 'ã€é‡è¦ã€‘è®¾å¤‡æŒ‡çº¹ï¼ˆ64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰ã€‚å¦‚æœå¡«å†™æ­¤å­—æ®µï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè®¾å¤‡ç»‘å®šçš„æ¿€æ´»ç ã€‚ä»…é€‚ç”¨äº release ç‰ˆæœ¬ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è¿è¡Œ scripts/get-device-fingerprint.js æˆ– scripts/get-device-fingerprint.ps1 è·å–è®¾å¤‡æŒ‡çº¹ã€‚'
        required: false
        default: ''
        type: string
      activation_code:
        description: 'ã€å¯é€‰ã€‘æ‰‹åŠ¨è¾“å…¥æ¿€æ´»ç ã€‚å¦‚æœä¸Šé¢å·²å¡«å†™è®¾å¤‡æŒ‡çº¹ï¼Œæ­¤å­—æ®µç•™ç©ºå³å¯ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ã€‚å¦‚æœä¸¤ä¸ªéƒ½å¡«å†™ï¼Œä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„æ¿€æ´»ç ã€‚'
        required: false
        default: ''
        type: string
      enable_devtools:
        description: 'ã€æµ‹è¯•ç”¨ã€‘æ˜¯å¦å¯ç”¨ DevToolsï¼ˆæ§åˆ¶å°ï¼‰ã€‚é€‰æ‹© true å¯ä»¥æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯ã€‚ä»…ç”¨äºæµ‹è¯•ï¼Œç”Ÿäº§ç¯å¢ƒè¯·é€‰æ‹© falseã€‚'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: pwsh
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $env:GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        shell: pwsh
        run: |
          # Remove existing node_modules to ensure clean install
          if (Test-Path "node_modules") {
            Write-Host "Removing existing node_modules for clean install..."
            Remove-Item -Recurse -Force "node_modules" -ErrorAction SilentlyContinue
          }

          # Install with hoisted mode (node-linker=hoisted in .npmrc)
          Write-Host "Installing dependencies with hoisted mode..."
          pnpm install --no-frozen-lockfile

          # Verify critical packages are in node_modules root
          Write-Host "Verifying node_modules structure..."
          $criticalPackages = @("app-builder-lib", "electron-builder", "builder-util")
          foreach ($pkg in $criticalPackages) {
            $pkgPath = "node_modules\$pkg"
            if (Test-Path $pkgPath) {
              Write-Host "âœ“ $pkg found in node_modules root"
            } else {
              Write-Warning "âš  $pkg not found in node_modules root"
              # Try to find it in .pnpm and create a hard link
              $pnpmPath = Get-ChildItem -Path "node_modules\.pnpm" -Filter "$pkg@*" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($pnpmPath) {
                $targetPath = Join-Path $pnpmPath.FullName "node_modules\$pkg"
                if (Test-Path $targetPath) {
                  Write-Host "Creating hard link for $pkg..."
                  # Use robocopy to create junction (works better than symlink on Windows)
                  $null = New-Item -ItemType Directory -Path "node_modules" -Force -ErrorAction SilentlyContinue
                  cmd /c mklink /J "$pkgPath" "$targetPath" 2>&1 | Out-Null
                }
              }
            }
          }

          # Verify electron-builder can find the files
          Write-Host "Verifying electron-builder installation..."
          pnpm exec electron-builder --version

      - name: Type check
        run: pnpm run typecheck
        continue-on-error: false

      - name: ç”Ÿæˆè®¾å¤‡ç»‘å®šæ¿€æ´»ç ï¼ˆå¦‚æœæä¾›äº†è®¾å¤‡æŒ‡çº¹ï¼‰
        shell: pwsh
        id: generate_code
        run: |
          $deviceFingerprint = "${{ github.event.inputs.device_fingerprint }}"
          $edition = "${{ github.event.inputs.edition }}"

          # Trim whitespace FIRST (before any checks)
          if (-not [string]::IsNullOrEmpty($deviceFingerprint)) {
            $originalLength = $deviceFingerprint.Length
            $deviceFingerprint = $deviceFingerprint.Trim()
            if ($originalLength -ne $deviceFingerprint.Length) {
              Write-Host "âš ï¸  æ£€æµ‹åˆ°è®¾å¤‡æŒ‡çº¹å‰åæœ‰ç©ºæ ¼ï¼Œå·²è‡ªåŠ¨å»é™¤" -ForegroundColor Yellow
              Write-Host "   åŸå§‹é•¿åº¦: $originalLength å­—ç¬¦" -ForegroundColor Gray
              Write-Host "   å»é™¤åé•¿åº¦: $($deviceFingerprint.Length) å­—ç¬¦" -ForegroundColor Gray
            }
          }

          # Debug: Show received values
          Write-Host "============================================================" -ForegroundColor Cyan
          Write-Host "æ£€æŸ¥è¾“å…¥å‚æ•°" -ForegroundColor Cyan
          Write-Host "============================================================" -ForegroundColor Cyan
          Write-Host "æ„å»ºç‰ˆæœ¬ (edition): '$edition'" -ForegroundColor Yellow
          if ($edition -ne 'release') {
            Write-Host "  âš ï¸  è­¦å‘Šï¼šè®¾å¤‡ç»‘å®šæ¿€æ´»ç ä»…é€‚ç”¨äº 'release' ç‰ˆæœ¬ï¼" -ForegroundColor Red
          }
          Write-Host ""
          Write-Host "è®¾å¤‡æŒ‡çº¹ (device_fingerprint):" -ForegroundColor Yellow
          if ([string]::IsNullOrEmpty($deviceFingerprint)) {
            Write-Host "  [æœªæä¾›æˆ–ä¸ºç©º]" -ForegroundColor Red
            Write-Host ""
            Write-Host "  ğŸ’¡ æç¤ºï¼š" -ForegroundColor Cyan
            Write-Host "     è¯·ç¡®ä¿å°†è®¾å¤‡æŒ‡çº¹è¾“å…¥åˆ° 'device_fingerprint' è¾“å…¥æ¡†" -ForegroundColor White
            Write-Host "     ï¼ˆä¸æ˜¯ 'activation_code' è¾“å…¥æ¡†ï¼‰" -ForegroundColor White
          } else {
            Write-Host "  âœ“ å·²æä¾›" -ForegroundColor Green
            Write-Host "  å€¼: '$deviceFingerprint'" -ForegroundColor White
            Write-Host "  é•¿åº¦: $($deviceFingerprint.Length) å­—ç¬¦" -ForegroundColor White
            if ($deviceFingerprint.Length -ge 16) {
              Write-Host "  å‰16ä½: $($deviceFingerprint.Substring(0, 16))" -ForegroundColor White
            }
            # Check for common issues
            if ($deviceFingerprint -match '\s') {
              Write-Host "  âš ï¸  è­¦å‘Šï¼šæ£€æµ‹åˆ°ç©ºæ ¼æˆ–æ¢è¡Œç¬¦ï¼" -ForegroundColor Red
            }
            if ($deviceFingerprint.Length -ne 64) {
              Write-Host "  âš ï¸  è­¦å‘Šï¼šé•¿åº¦ä¸æ˜¯64å­—ç¬¦ï¼" -ForegroundColor Red
            }
            if ($deviceFingerprint -notmatch '^[a-fA-F0-9]+$') {
              Write-Host "  âš ï¸  è­¦å‘Šï¼šåŒ…å«éåå…­è¿›åˆ¶å­—ç¬¦ï¼" -ForegroundColor Red
            }
          }
          Write-Host "============================================================" -ForegroundColor Cyan
          Write-Host ""

          if (-not [string]::IsNullOrEmpty($deviceFingerprint) -and $edition -eq 'release') {
            Write-Host "âœ“ æ£€æµ‹åˆ°è®¾å¤‡æŒ‡çº¹ï¼Œå¼€å§‹ç”Ÿæˆæ¿€æ´»ç ..." -ForegroundColor Green
            Write-Host "  è®¾å¤‡æŒ‡çº¹: $($deviceFingerprint.Substring(0, 16))..." -ForegroundColor White

            # Validate device fingerprint format (64 hex characters)
            if ($deviceFingerprint.Length -ne 64 -or $deviceFingerprint -notmatch '^[a-fA-F0-9]{64}$') {
              Write-Host ""
              Write-Host "âŒ è®¾å¤‡æŒ‡çº¹æ ¼å¼é”™è¯¯ï¼" -ForegroundColor Red
              Write-Host "   æœŸæœ›æ ¼å¼ï¼š64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆ0-9, a-f, A-Fï¼‰" -ForegroundColor Yellow
              Write-Host "   å®é™…å€¼ï¼š$deviceFingerprint" -ForegroundColor White
              Write-Host "   å®é™…é•¿åº¦ï¼š$($deviceFingerprint.Length) å­—ç¬¦" -ForegroundColor White
              Write-Host ""
              Write-Host "   è¯·æ£€æŸ¥ï¼š" -ForegroundColor Yellow
              Write-Host "   1. è®¾å¤‡æŒ‡çº¹å¿…é¡»æ˜¯64ä¸ªå­—ç¬¦" -ForegroundColor White
              Write-Host "   2. åªåŒ…å«åå…­è¿›åˆ¶å­—ç¬¦ï¼ˆ0-9, a-f, A-Fï¼‰" -ForegroundColor White
              Write-Host "   3. æ²¡æœ‰ç©ºæ ¼ã€æ¢è¡Œæˆ–å…¶ä»–ç‰¹æ®Šå­—ç¬¦" -ForegroundColor White
              Write-Host "   4. ç¡®ä¿è¾“å…¥åˆ° 'device_fingerprint' è¾“å…¥æ¡†ï¼Œè€Œä¸æ˜¯ 'activation_code'" -ForegroundColor White
              Write-Host ""
              Write-Host "   è·å–è®¾å¤‡æŒ‡çº¹çš„æ–¹æ³•ï¼š" -ForegroundColor Cyan
              Write-Host "   - è¿è¡Œ: node scripts/get-device-fingerprint.js" -ForegroundColor White
              Write-Host "   - æˆ–è¿è¡Œ: powershell -ExecutionPolicy Bypass -File scripts\get-device-fingerprint.ps1" -ForegroundColor White
              Write-Host ""
              exit 1
            }

            # Generate device-bound activation code using Node.js script
            Write-Host "æ­£åœ¨ç”Ÿæˆè®¾å¤‡ç»‘å®šæ¿€æ´»ç ..." -ForegroundColor Cyan
            $output = node scripts/generate-device-bound-code.js $deviceFingerprint 2>&1 | Out-String

            # Extract activation code from output (format: XXXX-XXXX-XXXX-XXXX)
            # Try multiple patterns to match the output format
            $activationCodeMatch = $null
            $patterns = @(
              'Activation Code:\s*([A-Z0-9-]{19})',
              'Activation Code: ([A-Z0-9-]{19})',
              'Activation Code:\s*([A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4})'
            )

            foreach ($pattern in $patterns) {
              $match = [regex]::Match($output, $pattern)
              if ($match.Success) {
                $activationCodeMatch = $match
                break
              }
            }

            if ($activationCodeMatch -and $activationCodeMatch.Success) {
              $generatedActivationCode = $activationCodeMatch.Groups[1].Value
              Write-Host "âœ“ æ¿€æ´»ç ç”ŸæˆæˆåŠŸ: $generatedActivationCode" -ForegroundColor Green
              "GENERATED_ACTIVATION_CODE=$generatedActivationCode" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            } else {
              Write-Host ""
              Write-Host "âŒ æ— æ³•ä»ç”Ÿæˆå™¨è¾“å‡ºä¸­æå–æ¿€æ´»ç " -ForegroundColor Red
              Write-Host "ç”Ÿæˆå™¨è¾“å‡ºï¼š" -ForegroundColor Yellow
              Write-Host $output
              Write-Host ""
              Write-Host "å°è¯•çš„æ¨¡å¼: $($patterns -join ', ')" -ForegroundColor Yellow
              exit 1
            }
          } else {
            Write-Host ""
            Write-Host "============================================================" -ForegroundColor Yellow
            Write-Host "è·³è¿‡æ¿€æ´»ç ç”Ÿæˆ" -ForegroundColor Yellow
            Write-Host "============================================================" -ForegroundColor Yellow
            if ([string]::IsNullOrEmpty($deviceFingerprint)) {
              Write-Host "åŸå› ï¼šæœªæä¾›è®¾å¤‡æŒ‡çº¹" -ForegroundColor Red
              Write-Host ""
              Write-Host "ğŸ’¡ è§£å†³æ–¹æ³•ï¼š" -ForegroundColor Cyan
              Write-Host "   1. åœ¨ GitHub Actions çš„ 'Run workflow' é¡µé¢" -ForegroundColor White
              Write-Host "   2. æ‰¾åˆ° 'device_fingerprint' è¾“å…¥æ¡†ï¼ˆåœ¨ 'activation_code' ä¹‹å‰ï¼‰" -ForegroundColor White
              Write-Host "   3. å°†è®¾å¤‡æŒ‡çº¹ç²˜è´´åˆ°è¯¥è¾“å…¥æ¡†" -ForegroundColor White
              Write-Host "   4. ç¡®ä¿ 'edition' é€‰æ‹©çš„æ˜¯ 'release'" -ForegroundColor White
              Write-Host ""
              Write-Host "   è·å–è®¾å¤‡æŒ‡çº¹çš„æ–¹æ³•ï¼š" -ForegroundColor Yellow
              Write-Host "   - è¿è¡Œ: node scripts/get-device-fingerprint.js" -ForegroundColor Gray
              Write-Host "   - æˆ–è¿è¡Œ: powershell -ExecutionPolicy Bypass -File scripts\get-device-fingerprint.ps1" -ForegroundColor Gray
            } elseif ($edition -ne 'release') {
              Write-Host "åŸå› ï¼šå½“å‰æ„å»ºç‰ˆæœ¬æ˜¯ '$edition'ï¼Œä¸æ˜¯ 'release'" -ForegroundColor Red
              Write-Host ""
              Write-Host "ğŸ’¡ è§£å†³æ–¹æ³•ï¼š" -ForegroundColor Cyan
              Write-Host "   è®¾å¤‡ç»‘å®šæ¿€æ´»ç ä»…é€‚ç”¨äº release ç‰ˆæœ¬" -ForegroundColor White
              Write-Host "   è¯·å°† 'edition' é€‰æ‹©ä¸º 'release'" -ForegroundColor White
            }
            Write-Host "============================================================" -ForegroundColor Yellow
            Write-Host ""
            "GENERATED_ACTIVATION_CODE=" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

      - name: Set build environment variables
        shell: pwsh
        run: |
          # Get edition from workflow_dispatch input
          $edition = "${{ github.event.inputs.edition }}"
          if ([string]::IsNullOrEmpty($edition)) {
            $edition = 'release'
          }

          $trialDuration = "${{ github.event.inputs.trial_duration }}"
          if ([string]::IsNullOrEmpty($trialDuration)) {
            $trialDuration = '5'
          }

          $trialUnit = "${{ github.event.inputs.trial_unit }}"
          if ([string]::IsNullOrEmpty($trialUnit)) {
            $trialUnit = 'minutes'
          }

          # Priority: manually provided activation code > generated from device fingerprint > empty
          $manualActivationCode = "${{ github.event.inputs.activation_code }}"
          $generatedActivationCode = "${{ env.GENERATED_ACTIVATION_CODE }}"

          $activationCode = $manualActivationCode
          if ([string]::IsNullOrEmpty($activationCode) -and -not [string]::IsNullOrEmpty($generatedActivationCode)) {
            $activationCode = $generatedActivationCode
            Write-Host "Using generated device-bound activation code"
          } elseif (-not [string]::IsNullOrEmpty($activationCode)) {
            Write-Host "Using manually provided activation code"
          }

          # Get enable_devtools from workflow_dispatch input
          $enableDevTools = "${{ github.event.inputs.enable_devtools }}"
          if ([string]::IsNullOrEmpty($enableDevTools)) {
            $enableDevTools = 'false'
          }

          Write-Host "Setting environment variables:"
          Write-Host "  VITE_EDITION=$edition"
          Write-Host "  VITE_TRIAL_DURATION=$trialDuration"
          Write-Host "  VITE_TRIAL_UNIT=$trialUnit"
          Write-Host "  VITE_ENABLE_DEVTOOLS=$enableDevTools"
          if (-not [string]::IsNullOrEmpty($activationCode)) {
            Write-Host "  VITE_ACTIVATION_CODE=*** (hidden)"
          }

          # Set environment variables for subsequent steps
          "VITE_EDITION=$edition" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "VITE_TRIAL_DURATION=$trialDuration" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "VITE_TRIAL_UNIT=$trialUnit" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "VITE_ENABLE_DEVTOOLS=$enableDevTools" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          if (-not [string]::IsNullOrEmpty($activationCode)) {
            "VITE_ACTIVATION_CODE=$activationCode" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

          if ($edition -eq 'trial') {
            Write-Host "Building TRIAL edition with duration: $trialDuration $trialUnit"
          } else {
            if (-not [string]::IsNullOrEmpty($activationCode)) {
              $deviceFingerprint = "${{ github.event.inputs.device_fingerprint }}"
              if (-not [string]::IsNullOrEmpty($deviceFingerprint)) {
                Write-Host "Building RELEASE edition with device-bound activation code (fingerprint: $($deviceFingerprint.Substring(0, 16))...)"
              } else {
                Write-Host "Building RELEASE edition with activation code"
              }
            } else {
              Write-Host "Building RELEASE edition (no activation code - will require activation on first run)"
            }
          }

      - name: Build application and Windows installer
        shell: pwsh
        run: |
          $edition = "${{ env.VITE_EDITION }}"
          $trialDuration = "${{ env.VITE_TRIAL_DURATION }}"
          $trialUnit = "${{ env.VITE_TRIAL_UNIT }}"

          $activationCode = "${{ env.VITE_ACTIVATION_CODE }}"

          Write-Host "Building with environment variables:"
          Write-Host "  VITE_EDITION=$edition"
          Write-Host "  VITE_TRIAL_DURATION=$trialDuration"
          Write-Host "  VITE_TRIAL_UNIT=$trialUnit"
          if (-not [string]::IsNullOrEmpty($activationCode)) {
            Write-Host "  VITE_ACTIVATION_CODE=*** (hidden)"
          }

          # Verify environment variables are set
          if ([string]::IsNullOrEmpty($edition)) {
            Write-Error "VITE_EDITION is not set!"
            exit 1
          }

          # Run typecheck first
          pnpm run typecheck

          # Build with electron-vite (environment variables are passed via env: section below)
          # The define config in electron.vite.config.ts will read these at build time
          pnpm exec electron-vite build

          # Verify the build output contains the correct edition
          $builtFile = "out/main/index.js"
          if (Test-Path $builtFile) {
            $content = Get-Content $builtFile -Raw
            if ($edition -eq "trial") {
              if ($content -notmatch '"trial"') {
                Write-Warning "Warning: Built file may not contain 'trial' edition"
              }
            } else {
              if ($content -notmatch '"release"') {
                Write-Warning "Warning: Built file may not contain 'release' edition"
              }
            }
          }

          # Build Windows installer
          # Set NODE_OPTIONS to handle long paths on Windows
          $env:NODE_OPTIONS = "--max-old-space-size=4096"

          # Final check before building
          $appBuilderLibPath = "node_modules\app-builder-lib"
          if (-not (Test-Path $appBuilderLibPath)) {
            Write-Error "app-builder-lib not found in node_modules root. Build will fail."
            exit 1
          }

          # Verify the NSIS template file exists
          $nsisTemplatePath = Join-Path $appBuilderLibPath "templates\nsis\include\allowOnlyOneInstallerInstance.nsh"
          if (Test-Path $nsisTemplatePath) {
            Write-Host "âœ“ NSIS template found: $nsisTemplatePath"
          } else {
            Write-Warning "âš  NSIS template not found at expected path"
            Write-Host "Searching for template file..."
            $foundTemplate = Get-ChildItem -Path "node_modules" -Filter "allowOnlyOneInstallerInstance.nsh" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($foundTemplate) {
              Write-Host "Found template at: $($foundTemplate.FullName)"
            } else {
              Write-Error "NSIS template file not found anywhere!"
              exit 1
            }
          }

          # Run electron-builder
          Write-Host "Starting electron-builder..."
          pnpm exec electron-builder --win
        env:
          VITE_EDITION: ${{ env.VITE_EDITION }}
          VITE_TRIAL_DURATION: ${{ env.VITE_TRIAL_DURATION }}
          VITE_TRIAL_UNIT: ${{ env.VITE_TRIAL_UNIT }}
          VITE_ACTIVATION_CODE: ${{ env.VITE_ACTIVATION_CODE }}
          VITE_ENABLE_DEVTOOLS: ${{ env.VITE_ENABLE_DEVTOOLS }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: List build artifacts
        shell: pwsh
        run: |
          Get-ChildItem -Path dist -Recurse | Select-Object FullName, Length | Format-Table

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-${{ env.VITE_EDITION }}-${{ github.sha }}
          path: |
            dist/*.exe
            dist/*.zip
            dist/*.blockmap
          retention-days: 30
          if-no-files-found: error

      - name: æ˜¾ç¤ºç”Ÿæˆçš„æ¿€æ´»ç ï¼ˆå¦‚æœä»è®¾å¤‡æŒ‡çº¹è‡ªåŠ¨ç”Ÿæˆï¼‰
        shell: pwsh
        if: env.GENERATED_ACTIVATION_CODE != ''
        run: |
          $deviceFingerprint = "${{ github.event.inputs.device_fingerprint }}"
          $activationCode = "${{ env.GENERATED_ACTIVATION_CODE }}"

          Write-Host ""
          Write-Host "============================================================" -ForegroundColor Green
          Write-Host "è®¾å¤‡ç»‘å®šæ¿€æ´»ç å·²ç”Ÿæˆ" -ForegroundColor Green
          Write-Host "============================================================" -ForegroundColor Green
          Write-Host "è®¾å¤‡æŒ‡çº¹: $($deviceFingerprint.Substring(0, 16))...$($deviceFingerprint.Substring(48))" -ForegroundColor White
          Write-Host "æ¿€æ´»ç : $activationCode" -ForegroundColor Yellow
          Write-Host "============================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "âš ï¸  é‡è¦ï¼šè¯·ä¿å­˜æ­¤æ¿€æ´»ç ï¼" -ForegroundColor Yellow
          Write-Host "   æ­¤æ¿€æ´»ç å·²ç»‘å®šåˆ°æŒ‡å®šè®¾å¤‡ã€‚" -ForegroundColor White
          Write-Host "   åªèƒ½åœ¨è¯¥è®¾å¤‡ä¸Šä½¿ç”¨ï¼Œæ— æ³•åœ¨å…¶ä»–è®¾å¤‡ä¸Šæ¿€æ´»ã€‚" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š" -ForegroundColor Cyan
          Write-Host "   1. ä» artifacts ä¸‹è½½å®‰è£…åŒ…" -ForegroundColor White
          Write-Host "   2. å°†å®‰è£…åŒ…å’Œæ¿€æ´»ç å‘é€ç»™ç”¨æˆ·" -ForegroundColor White
          Write-Host "   3. ç”¨æˆ·å®‰è£…è½¯ä»¶å¹¶è¾“å…¥æ¿€æ´»ç " -ForegroundColor White
          Write-Host ""

      # Note: Release creation is now manual only
      # To create a release, use GitHub's web interface or GitHub CLI after downloading artifacts
